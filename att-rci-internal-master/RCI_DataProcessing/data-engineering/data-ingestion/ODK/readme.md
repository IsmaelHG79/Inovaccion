![EncabezadoAxity][imgEncabezado]

# Documentación Data Ingestion para la fuente ATT **ODK**

## Descripción del `Servidor de Origen de Datos`  
El servidor donde se tomarán los archivos es:  ```10.150.25.146```.

Comando ```hdfs dfs -ls /data/RCI/raw/PANDA/ODK/data```

| Archivo 	|
|---------------------------------------	|
| /data/RCI/raw/PANDA/ODK/data/000000_0 	|
| /data/RCI/raw/PANDA/ODK/data/000001_0 	|
| /data/RCI/raw/PANDA/ODK/data/000002_0 	|
| /data/RCI/raw/PANDA/ODK/data/000003_0 	|
| /data/RCI/raw/PANDA/ODK/data/000004_0 	|
| /data/RCI/raw/PANDA/ODK/data/000005_0 	|
| /data/RCI/raw/PANDA/ODK/data/000006_0 	|
| /data/RCI/raw/PANDA/ODK/data/000007_0 	|
| /data/RCI/raw/PANDA/ODK/data/000008_0 	|
| /data/RCI/raw/PANDA/ODK/data/000009_0 	|
| /data/RCI/raw/PANDA/ODK/data/000010_0 	|
| /data/RCI/raw/PANDA/ODK/data/000011_0 	|
| /data/RCI/raw/PANDA/ODK/data/000012_0 	|
| /data/RCI/raw/PANDA/ODK/data/000013_0 	|
| /data/RCI/raw/PANDA/ODK/data/000014_0 	|
| /data/RCI/raw/PANDA/ODK/data/000015_0 	|
| /data/RCI/raw/PANDA/ODK/data/000016_0 	|

<<<<<<< HEAD
Para mas detalle revisar la siguiente documentacion: [Data Lake Guide](http://10.103.133.122/app/owncloud/f/14481174)
=======
Para mas detalle revisar la siguiente documentacion: [Data Lake Guide](http://10.103.133.122/app/owncloud/f/14480776)
>>>>>>> f17ccfc48c11b46af8c37c2b5c513a6316537378

## Descripción de la fuentes de datos
- **Descripción**

    - [ODK EDA 12](../../../../RCI_DataAnalysis/eda/ODK_12/README.md)
    - [ODK EDA 32](../../../../RCI_DataAnalysis/eda/ODK_32/README.md)
    - [ODK EDA 38](../../../../RCI_DataAnalysis/eda/ODK_38/README.md)
    - [ODK EDA 76](../../../../RCI_DataAnalysis/eda/ODK_76/README.md)
    - [ODK EDA 99](../../../../RCI_DataAnalysis/eda/ODK_99/README.md)


- **Diccionario de Datos**

    `describe formatted rci_network_db.tx_odk`

  | Nombre de Columna 	| Tipo de Dato 	| Comentario                                	|
  |-------------------	|--------------	|-------------------------------------------	|
  | id_form           	| string       	| Type inferred from '148748'               	|
  | clave_form        	| string       	| Type inferred from 'SINV'                 	|
  | form_element      	| string       	| Type inferred from 'id:root:groupStru...' 	|
  | atributo          	| string       	| Type inferred from 'Fila 1'               	|
  | no_informe      	  | string       	| Type inferred from 'Fila 2' 	              |
  | ma          	      | string       	| Type inferred from 'Fila 3'               	|

  Las siguientes columnas son creadas para la identidad de la fuente:

  | Nombre de Columna  	| Tipo de Dato 	| Comentario                                               	|
  |--------------------	|--------------	|----------------------------------------------------------	|
  | filedate           	| bigint       	| Type inferred from '20190807'                            	|
  | filename           	| string       	| Type inferred from '/data/RCI/raw/PANDA/ODK/data' 	|
  | hash_id            	| string       	| Type inferred from 'null'                                	|
  | sourceid           	| string       	| Type inferred from 'ODK'                                 	|
  | registry_state     	| string       	| Type inferred from 'null'                                	|
  | datasetname        	| string       	| Type inferred from 'ODK'                                 	|
  | timestamp          	| bigint       	| Type inferred from '20191126'                            	|
  | transaction_status 	| string       	| Type inferred from ''                                    	|

- **Particiones**


  A continuación se presentan las particiones creadas de la tabla **rci_network_db.tx_odk**.

  Sentencia: ```show partitions rci_network_db.tx_odk```

  | year 	| month 	| day 	| #Rows   	| #Files 	| Size   	| Format 	| Location                                                                       	|
  |------	|-------	|-----	|---------	|--------	|--------	|--------	|--------------------------------------------------------------------------------	|
  | 2020 	| 1    	| 9  	| 14286008 	| 2      	| 4.78GB 	| AVRO   	| hdfs://attdatalakehdfs/data/RCI/stg/hive/staging/odk/year=2020/month=1/day=9 	|

## Componentes del procesos de ingestión:

1 __Reglas de Estandarización del Esquema `Kite`__

Las siguientes reglas se aplicarán para estandarizar el esquema:

- Creación del esquema ```tx_odk.avsc``` sentencia: ```./rci_ingesta_generacion_avro.sh 45```

    ```
    {
  "type": "record",
  "name": "avroSchema",
  "doc": "Schema generated by Kite",
  "fields": [
    {
      "name": "Id_form",
      "type": [
        "null",
        "string"
      ],
      "doc": "Type inferred from '148748'"
    },
    {
      "name": "Clave_form",
      "type": [
        "null",
        "string"
      ],
      "doc": "Type inferred from 'SINV'"
    },
    {
      "name": "form_element",
      "type": [
        "null",
        "string"
      ],
      "doc": "Type inferred from 'id:root:groupStru...'"
    },
    {
      "name": "Atributo",
      "type": [
        "null",
        "string"
      ],
      "doc": "Type inferred from 'Fila 1'"
    },
    {
      "name": "no_informe",
      "type": [
        "null",
        "string"
      ],
      "doc": "Type inferred from 'Fila 2'"
    },
    {
      "name": "ma",
      "type": [
        "null",
        "string"
      ],
      "doc": "Type inferred from 'Fila 3'"
    },  
    {
      "name": "filedate",
      "type": [
        "null",
        "long"
      ],
      "doc": "Type inferred from '20190807'"
    },
    {
      "name": "filename",
      "type": [
        "null",
        "string"
      ],
      "doc": "Type inferred from 'File System'"
    },
    {
      "name": "hash_id",
      "type": [
        "null",
        "string"
      ],
      "doc": "Type inferred from 'null'",
      "default": null
    },
    {
      "name": "sourceid",
      "type": [
        "null",
        "string"
      ],
      "doc": "Type inferred from 'ODK'"
    },
    {
      "name": "registry_state",
      "type": [
        "null",
        "string"
      ],
      "doc": "Type inferred from 'null'",
      "default": null
    },
    {
      "name": "datasetName",
      "type": [
        "null",
        "string"
      ],
      "doc": "Type inferred from 'ODK'"
    },
    {
      "name": "timestamp",
      "type": [
        "null",
        "long"
      ],
      "doc": "Type inferred from '20191126'"
    }
	,
    {
      "name": "transaction_status",
      "type": [
        "null",
        "string"
      ],
      "doc": "Type inferred from ''"
    }
  ]
}

2 __Estrategia Full vía `Spark`__

- Especificar parámetros del shell kite:

| Parámetro   	| Valor del Parámetro                                                                                   	| Descripción del Parámetro                            	|
|-------------	|-------------------------------------------------------------------------------------------------------	|------------------------------------------------------	|
| parametro1  	| yarn-cluster                                                                                          	| Modo de ejecución de aplicación spark.               	|
| parametro2  	| cluster                                                                                               	| Modo en que se despliega la aplicación.              	|
| parametro3  	| 'Delta SPARK ODK '                                                                         	| Nombre de la aplicación spark.                       	|
| parametro4  	| root.rci                                                                                              	| Nombre del recurso queue.                            	|
| parametro5  	| com.axity.DataFlowIngestionODK                                                                           	| Nombre de la clase.                                  	|
| parametro6  	| /home/raw_rci/attdlkrci/spark/spark-scala-maven-project-0.0.1-SNAPSHOT-jar-with-dependencies.jar| Ruta del archivo jar.                                	|
| parametro7  	| /data/RCI/raw/PANDA/ODK/data                                                                               	| Directorio de área stage de datos.                   	|
| parametro8  	| tx_odk                                                                                        	| Nombre de la tabla destino.                          	|
| parametro9  	| hash_id                                                                                               	| Nombre del atributo hash_id.                         	|
| parametro10 	| hive                                                                                                  	| Formato de registro de almacenamiento.               	|
| parametro11 	| hive Id_form,Clave_form,form_element,Atributo| Campos de cálculo para llave Hash.                   	|
| parametro12 	| {YYYYMMDD}                                                  	| Fecha de proceso.Ej: 20191202|
| parametro13 	| /data/RCI/stg/hive/work/ctl/ctrl_tx_odk/{YYYYMMDD}| Directorio de salida de cifra control.               	|
| parametro14 	| full                                                                                                  	| Indicador de tipo de incrementalidad: full ó nofull. 	|
| parametro15 	| 6                                                                                                     	| Número de compactación de coalesce.                  	|

  Agregar la línea de ejecución spark

  ```
spark-submit --master {parametro1} --deploy-mode {parametro2} --name {parametro3} --queue={parametro4} -class {parametro5} {parametro6} {parametro7} {parametro8} {parametro9} {parametro10} {parametr11} {parametro12} {parametro13} {parametro14} {parametro15}

  ```
Ejemplo:

```
spark-submit --master yarn --deploy-mode client --name 'Delta SPARK ODK' --queue=root.rci --class com.axity.DataFlowIngestionODK /home/fh967x/SparkNew/spark-scala-maven-project-0.0.1-SNAPSHOT-jar-with-dependencies.jar /data/RCI/raw/PANDA/ODK/data 'rci_network_db.tx_odk' hash_id hive Id_form,Clave_form,form_element,Atributo,no_informe,ma 20200109 /data/RCI/stg/hive/work/ctl/ctrl_tx_odk/ full 6

```

## Referencias al Framework de Ingestion

- [Framework de Ingestion](../Globales/ArquitecturaFrameworkIngestion/readme.md)

## Código Fuente Local

- N/A

## Código Fuente Globales

- [Codigo Spark](../Globales/SparkAxity)
- [Codigo Kite](../Globales/attdlkrci/readme.md)


[imgEncabezado]:../Globales/ArquitecturaFrameworkIngestion/images/encabezado.png ""
